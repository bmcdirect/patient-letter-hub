import { prisma } from './db';
import { auth } from '@clerk/nextjs/server';
import { clerkClient } from '@clerk/nextjs/server';

export async function getCurrentUser() {
  try {
    console.log('üîß Starting Clerk session check...');

    const { userId } = await auth();
    console.log('üîß Clerk userId:', userId);

    if (!userId) {
      console.log('‚ùå No Clerk user ID found - user not authenticated');
      return null;
    }

    // 1. Try to find user in your DB by clerkId (always include practice)
    let user = await prisma.user.findUnique({
      where: { clerkId: userId },
      include: { practice: true }
    });

    if (user) {
      console.log('‚úÖ Found user by clerkId:', user.email);
      console.log('üìã User details:', {
        role: user.role,
        practiceId: user.practiceId,
        practiceName: user.practice?.name || 'None',
        hasPractice: !!user.practice
      });

      // Validate practice relationship
      if (user.practiceId && !user.practice) {
        console.error('‚ö†Ô∏è  User has practiceId but no practice data:', {
          userId: user.id,
          practiceId: user.practiceId
        });
        // Return user without practice data - let UI handle gracefully
        return user;
      }

      return user;
    }

    // 2. If not found by clerkId, fetch user from Clerk
    const clerkUser = await clerkClient.users.getUser(userId);
    const clerkEmail = clerkUser.emailAddresses[0]?.emailAddress;

    console.log('üîß Clerk user data:', {
      id: clerkUser.id,
      email: clerkEmail,
      firstName: clerkUser.firstName,
      lastName: clerkUser.lastName
    });

    if (!clerkEmail) {
      console.log('‚ùå No email found in Clerk user');
      return null;
    }

    // 3. Try to find existing user by email (for linking existing accounts)
    user = await prisma.user.findUnique({
      where: { email: clerkEmail },
      include: { practice: true }
    });

    if (user) {
      // 4. Link existing Prisma user to Clerk
      console.log('üîó Linking existing Prisma user to Clerk:', user.email);
      user = await prisma.user.update({
        where: { id: user.id },
        data: { clerkId: userId },
        include: { practice: true }
      });
      console.log('‚úÖ Successfully linked user to Clerk');
      console.log('üìã User details:', {
        role: user.role,
        practiceId: user.practiceId,
        practiceName: user.practice?.name || 'None',
        hasPractice: !!user.practice
      });

      // Validate practice relationship
      if (user.practiceId && !user.practice) {
        console.error('‚ö†Ô∏è  User has practiceId but no practice data after linking:', {
          userId: user.id,
          practiceId: user.practiceId
        });
        // Return user without practice data - let UI handle gracefully
        return user;
      }

      return user;
    }

    // 5. If user not found anywhere, they need to complete sign-up
    console.log('‚ö†Ô∏è  User not found in database - needs to complete sign-up process');
    return null;

  } catch (error) {
    console.error('‚ùå Error in getCurrentUser:', error);
    return null;
  }
}

export function getAuthUrls() {
  return {
    loginUrl: "/sign-in",
    signUpUrl: "/sign-up",
  };
}

// Helper function to get user by Clerk ID (always include practice)
export async function getUserByClerkId(clerkId: string) {
  return await prisma.user.findUnique({
    where: { clerkId },
    include: { practice: true }
  });
}

// Helper function to create or update user with Clerk ID
export async function upsertUserWithClerkId(clerkId: string, userData: {
  email: string;
  name?: string;
  role?: 'ADMIN' | 'USER';
  practiceId?: string;
}) {
  // Validate practiceId if provided
  if (userData.practiceId) {
    const practice = await prisma.practice.findUnique({
      where: { id: userData.practiceId }
    });
    
    if (!practice) {
      throw new Error(`Practice with ID ${userData.practiceId} not found`);
    }
  }

  return await prisma.user.upsert({
    where: { clerkId },
    update: {
      email: userData.email,
      name: userData.name,
      role: userData.role,
      practiceId: userData.practiceId,
    },
    create: {
      clerkId,
      email: userData.email,
      name: userData.name,
      role: userData.role || 'USER',
      practiceId: userData.practiceId || null, // Allow null for SuperAdmin
    },
    include: { practice: true }
  });
} 